<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wildfire Risk & Evacuation Planner</title>
    
    <!-- Leaflet CSS - Use CDN -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div id="map-container">
        <div id="map"></div>
        
        <!-- Enhanced Control Panel -->
        <div id="control-panel">
            <h3>üî• Wildfire Risk & Evacuation Planner</h3>
            
            <!-- Time Controls with Integrated Animation -->
            <div class="control-group">
                <h4>‚è∞ Temporal Controls</h4>
                <div class="time-display">
                    <span id="time-display">06:00 AM</span>
                </div>
                <input type="range" id="time-slider" min="0" max="17" value="0" step="1">
                <div class="animation-controls">
                    <button id="play-toggle" class="btn btn-primary">‚ñ∂Ô∏è Play Animation</button>
                    <div class="speed-controls">
                        <button id="speed-fast" class="btn btn-warning" style="font-size: 11px;">Fast (0.5s)</button>
                        <button id="speed-normal" class="btn btn-primary" style="font-size: 11px;">Normal (1s)</button>
                        <button id="speed-slow" class="btn btn-primary" style="font-size: 11px;">Slow (2s)</button>
                    </div>
                    <span id="speed-display" style="font-size: 11px; color: #666; margin-top: 3px; text-align: center;">Normal (1s)</span>
                </div>
            </div>
            
            <!-- Layer Controls with Progressive Disclosure -->
            <div class="control-group">
                <h4>üó∫Ô∏è Map Layers</h4>
                <label><input type="checkbox" id="fire-risk" checked> Fire Risk Surface</label>
                <label><input type="checkbox" id="fire-perimeters" checked> Fire Perimeters</label>
                <label><input type="checkbox" id="evacuation-buffers" checked> Evacuation Buffers</label>
                <label><input type="checkbox" id="population-centers" checked> Population Centers</label>
                <label><input type="checkbox" id="evacuation-centers"> Evacuation Centers</label>
                <label><input type="checkbox" id="evacuation-zones"> Evacuation Zones</label> <!-- ADD THIS -->
                <label><input type="checkbox" id="weather-stations"> Weather Stations</label>
                <label><input type="checkbox" id="historical-fires"> Historical Fires</label>
                <label><input type="checkbox" id="buffer-intersections"> Buffer Intersections</label>
            </div>
            
            <!-- Analysis Tools -->
            <div class="control-group">
                <h4>üìä Analysis Tools</h4>
                <button id="comparison-toggle" class="btn btn-primary">Historical Comparison</button>
                <button id="plan-routes" class="btn btn-success">üìç Plan Evacuation Routes</button>
                <button id="alert-communities" class="btn btn-warning">üö® Alert Communities</button>
                <button id="clear-routes" class="btn btn-secondary">Clear Routes</button>
                <button id="export-report" class="btn btn-success">Export Report</button>
            </div>
            
            <!-- Risk Legend -->
            <div class="risk-legend">
                <strong>Risk Levels:</strong>
                <div class="legend-item">
                    <div class="legend-color" style="background: #8B0000;"></div>
                    <span>Extreme</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #DC143C;"></div>
                    <span>High</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #FF8C00;"></div>
                    <span>Moderate</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #32CD32;"></div>
                    <span>Low</span>
                </div>
            </div>
        </div>
        
        <!-- Narrative Guidance Panel -->
        <div id="narrative-panel">
            <div id="narrative-text">
                Early morning conditions: Light winds, low humidity. Fire risk is moderate. Use the time slider to explore how conditions change throughout the day.
            </div>
            <div id="narrative-timestamp">
                Ready for analysis...
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- External Libraries -->
    <script src="lib/jquery-3.5.1.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- ADD THIS FIRE DATA SCRIPT FIRST -->
    <script src="js/data/FireProgressionData.js"></script>

    <!-- Core WildfireApp FIRST -->
    <script src="js/core/WildfireApp.js"></script>

    <!-- Other core modules -->
    <script src="js/core/MapManager.js"></script>
    <script src="js/modules/BufferSystem.js"></script>

    <!-- Managers in dependency order -->
    <script src="js/modules/NarrativeManager.js"></script>
    <script src="js/modules/DataLoader.js"></script>
    <script src="js/modules/PopulationManager.js"></script>
    <script src="js/modules/FireManager.js"></script>
    <script src="js/modules/WeatherManager.js"></script>
    <script src="js/modules/EvacuationManager.js"></script>
    <script src="js/modules/RouteManager.js"></script>
    <script src="js/modules/AnimationManager.js"></script>
    <script src="js/modules/LayerManager.js"></script>
    <script src="js/modules/ComparisonManager.js"></script>

    <!-- Event handlers LAST -->
    <script src="js/modules/EventHandlers.js"></script>

    <!-- App initialization and fallback functionality -->
    <script src="js/app.js"></script>

    <!-- Consolidated initialization script -->
    <script>
    $(document).ready(function() {
        // Safety check and function definitions
        if (typeof window.updateTimeDisplay === 'undefined') {
            window.updateTimeDisplay = function(timeValue) {
                console.warn('updateTimeDisplay called before proper initialization');
                const times = [
                    '06:00 AM', '07:00 AM', '08:00 AM', '09:00 AM', '10:00 AM', '11:00 AM',
                    '12:00 PM', '01:00 PM', '02:00 PM', '03:00 PM', '04:00 PM', '05:00 PM',
                    '06:00 PM', '07:00 PM', '08:00 PM', '09:00 PM', '10:00 PM', '11:00 PM'
                ];
                const displayTime = times[timeValue] || '12:00 PM';
                $('#time-display').text(displayTime);
            };
        }
        
        setTimeout(function() {
            console.log('=== Running consolidated fallback initialization ===');
            
            const waitForMap = function(callback, maxAttempts = 50) {
                let attempts = 0;
                const checkMap = function() {
                    attempts++;
                    console.log(`Checking for WildfireApp.map (attempt ${attempts})`);
                    
                    if (typeof WildfireApp !== 'undefined' && WildfireApp.map) {
                        console.log('‚úÖ WildfireApp.map is available');
                        callback();
                    } else if (attempts < maxAttempts) {
                        console.log('‚è≥ WildfireApp.map not ready yet, retrying...');
                        setTimeout(checkMap, 200);
                    } else {
                        console.error('‚ùå WildfireApp.map failed to initialize after max attempts');
                        if (typeof WildfireApp !== 'undefined' && !WildfireApp.map) {
                            console.log('Attempting to initialize WildfireApp...');
                            WildfireApp.init();
                            setTimeout(() => {
                                if (WildfireApp.map) {
                                    callback();
                                } else {
                                    console.error('Failed to initialize WildfireApp.map');
                                }
                            }, 1000);
                        }
                    }
                };
                checkMap();
            };
            
            waitForMap(function() {
                console.log('üéØ WildfireApp.map confirmed available, proceeding with initialization...');
                initializeFallbackManagers();
            });
            
            function initializeFallbackManagers() {
                // Create missing managers FIRST
                if (typeof WeatherManager === 'undefined') {
                    console.log('Creating fallback WeatherManager');
                    window.WeatherManager = {
                        init: function() {
                            console.log('WeatherManager initialized');
                        },
                        createWeatherStations: function() {
                            if (!WildfireApp.layers || !WildfireApp.layers.weatherStations) {
                                console.warn('Weather stations layer not available');
                                return;
                            }
                            
                            console.log('Creating weather stations...');
                            WildfireApp.layers.weatherStations.clearLayers();
                            
                            const stations = [
                                { name: 'Palm Springs Station', coordinates: [33.8303, -116.5453], temp: 95, humidity: 15, windSpeed: 12, windDirection: 'SW' },
                                { name: 'Desert Hot Springs Station', coordinates: [33.9614, -116.5019], temp: 98, humidity: 12, windSpeed: 18, windDirection: 'W' },
                                { name: 'San Jacinto Station', coordinates: [33.7839, -116.9586], temp: 92, humidity: 18, windSpeed: 15, windDirection: 'SW' },
                                { name: 'Hemet Station', coordinates: [33.7475, -116.9719], temp: 89, humidity: 22, windSpeed: 10, windDirection: 'S' }
                            ];
                            
                            let successCount = 0;
                            stations.forEach(station => {
                                try {
                                    const marker = L.marker(station.coordinates, {
                                        icon: L.divIcon({
                                            className: 'weather-station-icon',
                                            html: '<div style="background: #00BCD4; color: white; padding: 6px; border-radius: 50%; text-align: center; font-size: 14px; box-shadow: 0 2px 6px rgba(0,0,0,0.3); width: 28px; height: 28px; line-height: 16px;">üå°Ô∏è</div>',
                                            iconSize: [28, 28],
                                            iconAnchor: [14, 14]
                                        })
                                    }).addTo(WildfireApp.layers.weatherStations);
                                    
                                    marker.bindPopup(`
                                        <div style="min-width: 200px;">
                                            <h4 style="color: #00BCD4;">üå°Ô∏è ${station.name}</h4>
                                            <div style="font-size: 12px;">
                                                <strong>Temperature:</strong> ${station.temp}¬∞F<br>
                                                <strong>Humidity:</strong> ${station.humidity}%<br>
                                                <strong>Wind:</strong> ${station.windSpeed} mph ${station.windDirection}<br>
                                                <strong>Fire Risk:</strong> ${station.humidity < 20 ? 'High' : 'Moderate'}
                                            </div>
                                        </div>
                                    `);
                                    successCount++;
                                } catch (error) {
                                    console.error(`Error creating weather station ${station.name}:`, error);
                                }
                            });
                            
                            console.log(`‚úÖ Created ${successCount} weather stations`);
                            return successCount;
                        }
                    };
                }
                
                if (typeof BufferSystem === 'undefined') {
                    console.log('Creating fallback BufferSystem');
                    window.BufferSystem = {
                        init: function() {
                            console.log('BufferSystem initialized');
                        },
                        createBufferIntersections: function() {
                            if (!WildfireApp.layers || !WildfireApp.layers.bufferIntersections) {
                                console.warn('Buffer intersections layer not available');
                                return;
                            }
                            
                            console.log('Creating buffer intersections...');
                            WildfireApp.layers.bufferIntersections.clearLayers();
                            
                            const bufferZones = [
                                { name: 'San Jacinto Fire Buffer', center: [33.7839, -116.9586], radius: 2000, color: '#FF6B35' },
                                { name: 'Desert Hills Fire Buffer', center: [33.7500, -116.4000], radius: 2500, color: '#FF8E53' },
                                { name: 'Hemet Protection Buffer', center: [33.7475, -116.9719], radius: 1800, color: '#FF9068' }
                            ];
                            
                            let successCount = 0;
                            bufferZones.forEach(zone => {
                                try {
                                    const circle = L.circle(zone.center, {
                                        color: zone.color,
                                        fillColor: zone.color,
                                        fillOpacity: 0.3,
                                        weight: 2,
                                        radius: zone.radius
                                    }).addTo(WildfireApp.layers.bufferIntersections);
                                    
                                    circle.bindPopup(`
                                        <div style="min-width: 200px;">
                                            <h4 style="color: #FF6B35;">‚ö†Ô∏è San Jacinto Fire Buffer</h4>
                                            <div style="font-size: 12px;">
                                                <strong>Buffer Radius:</strong> ${(zone.radius/1000).toFixed(1)} km<br>
                                                <strong>Purpose:</strong> Fire containment zone<br>
                                                <strong>Status:</strong> Active monitoring<br>
                                                <strong>Risk Level:</strong> Moderate to High
                                            </div>
                                        </div>
                                    `);
                                    successCount++;
                                } catch (error) {
                                    console.error(`Error creating buffer zone ${zone.name}:`, error);
                                }
                            });
                            
                            console.log(`‚úÖ Created ${successCount} buffer intersections`);
                            return successCount;
                        }
                    };
                }
                
                // Create historical fires
                if (!window.createHistoricalFires) {
                    console.log('Creating createHistoricalFires function');
                    window.createHistoricalFires = function() {
                        if (!WildfireApp.layers || !WildfireApp.layers.historicalFires) {
                            console.warn('Historical fires layer not available');
                            return 0;
                        }
                        
                        console.log('Creating historical fires...');
                        WildfireApp.layers.historicalFires.clearLayers();
                        
                        const fires = [
                            {name: 'Apple Fire (2020)', coordinates: [33.8500, -116.9000], acres: 33424, year: 2020, cause: 'Vehicle'},
                            {name: 'Fairview Fire (2022)', coordinates: [33.7200, -116.8500], acres: 2707, year: 2022, cause: 'Electrical'},
                            {name: 'Rabbit Fire (2021)', coordinates: [33.6800, -116.7500], acres: 8894, year: 2021, cause: 'Undetermined'},
                            {name: 'Sand Fire (2019)', coordinates: [33.8800, -116.6000], acres: 1500, year: 2019, cause: 'Lightning'}
                        ];
                        
                        let successCount = 0;
                        fires.forEach(fire => {
                            try {
                                const circle = L.circle(fire.coordinates, {
                                    color: '#8B4513',
                                    fillColor: '#D2691E',
                                    fillOpacity: 0.4,
                                    weight: 2,
                                    radius: Math.sqrt(fire.acres) * 10
                                }).addTo(WildfireApp.layers.historicalFires);
                                
                                circle.bindPopup(`
                                    <div style="min-width: 200px;">
                                        <h4 style="color: #8B4513;">üî• ${fire.name}</h4>
                                        <div style="font-size: 12px;">
                                            <strong>Year:</strong> ${fire.year}<br>
                                            <strong>Size:</strong> ${fire.acres.toLocaleString()} acres<br>
                                            <strong>Cause:</strong> ${fire.cause}<br>
                                            <strong>Status:</strong> Contained
                                        </div>
                                    </div>
                                `);
                                successCount++;
                            } catch (error) {
                                console.error(`Error creating historical fire ${fire.name}:`, error);
                            }
                        });
                        
                        console.log(`Created ${successCount} historical fires`);
                        return successCount;
                    };
                }
                
                // Create evacuation centers
                if (!window.createEvacuationCenters) {
                    console.log('Creating createEvacuationCenters function');
                    window.createEvacuationCenters = function() {
                        if (!WildfireApp.layers || !WildfireApp.layers.evacuationCenters) {
                            console.warn('Evacuation centers layer not available');
                            return 0;
                        }
                        
                        console.log('Creating evacuation centers...');
                        WildfireApp.layers.evacuationCenters.clearLayers();
                        
                        const evacuationCenters = [
                            { name: 'Desert Recreation District', coordinates: [33.7269, -116.2725], capacity: 2000, facilities: ['Medical', 'Pet-Friendly', 'Wheelchair Accessible'], status: 'Available' },
                            { name: 'Palm Desert Civic Center', coordinates: [33.7506, -116.3756], capacity: 1500, facilities: ['Medical', 'Food Service', 'Wheelchair Accessible'], status: 'Available' },
                            { name: 'College of the Desert', coordinates: [33.7200, -116.3600], capacity: 3000, facilities: ['Large Capacity', 'Medical', 'Pet-Friendly', 'Wheelchair Accessible'], status: 'Available' },
                            { name: 'San Jacinto Community Center', coordinates: [33.7839, -116.9586], capacity: 800, facilities: ['Medical', 'Food Service'], status: 'Available' },
                            { name: 'Hemet High School', coordinates: [33.7475, -116.9719], capacity: 1200, facilities: ['Large Capacity', 'Medical', 'Pet-Friendly'], status: 'Available' }
                        ];
                        
                        let successCount = 0;
                        evacuationCenters.forEach(center => {
                            try {
                                const marker = L.marker(center.coordinates, {
                                    icon: L.divIcon({
                                        className: 'evacuation-center-icon',
                                        html: '<div style="background: #2196F3; color: white; padding: 8px; border-radius: 8px; text-align: center; font-size: 16px; box-shadow: 0 3px 8px rgba(0,0,0,0.4); width: 32px; height: 32px; line-height: 16px; border: 2px solid white;">üèõÔ∏è</div>',
                                        iconSize: [32, 32],
                                        iconAnchor: [16, 16]
                                    })
                                }).addTo(WildfireApp.layers.evacuationCenters);
                                
                                marker.bindPopup(`
                                    <div style="min-width: 250px;">
                                        <h4 style="color: #2196F3;">üèõÔ∏è ${center.name}</h4>
                                        <div style="font-size: 12px; line-height: 1.4;">
                                            <strong>Capacity:</strong> ${center.capacity.toLocaleString()} people<br>
                                            <strong>Status:</strong> <span style="color: green;">${center.status}</span><br>
                                            <strong>Facilities:</strong> ${center.facilities.join(', ')}
                                        </div>
                                    </div>
                                `);
                                successCount++;
                            } catch (error) {
                                console.error(`Error creating evacuation center ${center.name}:`, error);
                            }
                        });
                        
                        console.log(`Created ${successCount} evacuation centers`);
                        return successCount;
                    };
                }
                
                // Create evacuation buffers
                if (!window.createEvacuationBuffers) {
                    console.log('Creating createEvacuationBuffers function');
                    window.createEvacuationBuffers = function() {
                        if (!WildfireApp.layers || !WildfireApp.layers.evacuationZones) {
                            console.warn('Evacuation zones layer not available');
                            return 0;
                        }
                        
                        console.log('Creating evacuation buffers...');
                        WildfireApp.layers.evacuationZones.clearLayers();
                        
                        const fireAreas = [
                            { name: 'San Jacinto Fire Evacuation Zone', center: [33.7839, -116.9586], radius: 3000, level: 'Mandatory' },
                            { name: 'Desert Hills Fire Evacuation Zone', center: [33.7500, -116.4000], radius: 2500, level: 'Warning' }
                        ];
                        
                        let successCount = 0;
                        fireAreas.forEach(area => {
                            try {
                                const color = area.level === 'Mandatory' ? '#D32F2F' : '#FF9800';
                                
                                const circle = L.circle(area.center, {
                                    color: color,
                                    fillColor: color,
                                    fillOpacity: 0.2,
                                    weight: 3,
                                    radius: area.radius
                                }).addTo(WildfireApp.layers.evacuationZones);
                                
                                circle.bindPopup(`
                                    <div style="min-width: 200px;">
                                        <h4 style="color: ${color};">‚ö†Ô∏è ${area.name}</h4>
                                        <div style="font-size: 12px;">
                                            <strong>Evacuation Level:</strong> ${area.level}<br>
                                            <strong>Buffer Radius:</strong> ${(area.radius/1000).toFixed(1)} km<br>
                                            <strong>Status:</strong> Active<br>
                                            ${area.level === 'Mandatory' ? '<strong style="color: red;">EVACUATE NOW</strong>' : '<strong style="color: orange;">BE PREPARED TO EVACUATE</strong>'}
                                        </div>
                                    </div>
                                `);
                                successCount++;
                            } catch (error) {
                                console.error(`Error creating evacuation buffer ${area.name}:`, error);
                            }
                        });
                        
                        console.log(`Created ${successCount} evacuation buffers`);
                        return successCount;
                    };
                }
                
                // Initialize managers
                try { 
                    if (WeatherManager && WeatherManager.init) WeatherManager.init(); 
                } catch (e) { 
                    console.warn('WeatherManager init failed:', e); 
                }
                
                try { 
                    if (BufferSystem && BufferSystem.init) BufferSystem.init(); 
                } catch (e) { 
                    console.warn('BufferSystem init failed:', e); 
                }
                
                // Create data
                try {
                    createHistoricalFires();
                    createEvacuationCenters(); 
                    createEvacuationBuffers();
                } catch (e) {
                    console.error('Error creating data:', e);
                }
                
                // Set up layer toggles
                setTimeout(() => {
                    console.log('Setting up layer toggles...');
                    
                    // Update the layer toggles array to include evacuation-zones:
                    const toggles = [
                        { id: '#fire-risk', layer: 'fireRisk' },
                        { id: '#fire-perimeters', layer: 'firePerimeters' },
                        { id: '#evacuation-buffers', layer: 'evacuationZones' },
                        { id: '#population-centers', layer: 'populationCenters' },
                        { id: '#evacuation-centers', layer: 'evacuationCenters' },
                        { id: '#evacuation-zones', layer: 'evacuationZones' }, // ADD THIS
                        { id: '#weather-stations', layer: 'weatherStations' },
                        { id: '#historical-fires', layer: 'historicalFires' },
                        { id: '#buffer-intersections', layer: 'bufferIntersections' }
                    ];
                    
                    toggles.forEach(toggle => {
                        $(toggle.id).off('change').on('change', function() {
                            console.log(`Toggle ${toggle.id} clicked:`, $(this).is(':checked'));
                            
                            if (!WildfireApp.layers || !WildfireApp.layers[toggle.layer] || !WildfireApp.map) {
                                console.error(`Dependencies not available for ${toggle.layer}`);
                                return;
                            }
                            
                            if ($(this).is(':checked')) {
                                // Special handling for weather stations and buffer intersections
                                if (toggle.layer === 'weatherStations') {
                                    console.log('üå°Ô∏è Creating weather stations...');
                                    if (WeatherManager && WeatherManager.createWeatherStations) {
                                        try {
                                            const count = WeatherManager.createWeatherStations();
                                            console.log(`‚úÖ Weather stations created successfully: ${count}`);
                                        } catch (error) {
                                            console.error('‚ùå Error creating weather stations:', error);
                                        }
                                    } else {
                                        console.error('‚ùå WeatherManager or createWeatherStations not available');
                                        console.log('Available WeatherManager:', WeatherManager);
                                    }
                                }
                                
                                if (toggle.layer === 'bufferIntersections') {
                                    console.log('üîÑ Creating buffer intersections...');
                                    if (BufferSystem && BufferSystem.createBufferIntersections) {
                                        try {
                                            const count = BufferSystem.createBufferIntersections();
                                            console.log(`‚úÖ Buffer intersections created successfully: ${count}`);
                                        } catch (error) {
                                            console.error('‚ùå Error creating buffer intersections:', error);
                                        }
                                    } else {
                                        console.error('‚ùå BufferSystem or createBufferIntersections not available');
                                        console.log('Available BufferSystem:', BufferSystem);
                                    }
                                }
                                
                                // Add layer to map
                                if (!WildfireApp.map.hasLayer(WildfireApp.layers[toggle.layer])) {
                                    WildfireApp.layers[toggle.layer].addTo(WildfireApp.map);
                                    console.log(`‚úÖ Layer ${toggle.layer} added to map`);
                                } else {
                                    console.log(`‚ÑπÔ∏è Layer ${toggle.layer} already on map`);
                                }
                            } else {
                                // Remove layer from map
                                if (WildfireApp.map.hasLayer(WildfireApp.layers[toggle.layer])) {
                                    WildfireApp.map.removeLayer(WildfireApp.layers[toggle.layer]);
                                    console.log(`‚ûñ Layer ${toggle.layer} removed from map`);
                                }
                            }
                        });
                    });
                    
                    // Ensure initially checked layers are visible
                    setTimeout(() => {
                        console.log('Adding initially checked layers to map...');
                        
                        toggles.forEach(toggle => {
                            if ($(toggle.id).is(':checked') && WildfireApp.layers[toggle.layer]) {
                                try {
                                    if (!WildfireApp.map.hasLayer(WildfireApp.layers[toggle.layer])) {
                                        WildfireApp.layers[toggle.layer].addTo(WildfireApp.map);
                                        console.log(`Initial layer ${toggle.layer} added to map`);
                                    }
                                } catch (e) {
                                    console.warn(`Failed to add initial layer ${toggle.layer}:`, e);
                                }
                            }
                        });
                    }, 500);
                    
                    console.log('‚úÖ All layer toggles set up successfully');
                    
                }, 1000);
                
            } // FIXED: Missing closing bracket for initializeFallbackManagers function
            
        }); // FIXED: Missing closing bracket for waitForMap callback
        
    }, 1000); // End of setTimeout // ADD this missing closing bracket for $(document).ready

// Listen for WildfireApp ready event
window.addEventListener('wildfireAppReady', function() {
    console.log('üéØ WildfireApp ready event received');
    
    // Now it's safe to call FireManager methods
    if (typeof FireManager !== 'undefined' && FireManager.createFirePerimeters) {
        setTimeout(() => {
            console.log('Creating fire perimeters after WildfireApp ready...');
            FireManager.createFirePerimeters(12);
        }, 100);
    }
});
</script>

<!-- Add the time controls and animation functionality -->
<script>
$(document).ready(function() {
    // Wait for WildfireApp to be ready before setting up time controls
    setTimeout(function() {
        console.log('Setting up time controls and animation...');
        
        let animationInterval = null;
        let animationSpeed = 1000; // Default 1 second
        let isPlaying = false;
        
        // Define time functions
        function updateTimeDisplay(timeValue) {
            const times = [
                '06:00 AM', '07:00 AM', '08:00 AM', '09:00 AM', '10:00 AM', '11:00 AM',
                '12:00 PM', '01:00 PM', '02:00 PM', '03:00 PM', '04:00 PM', '05:00 PM',
                '06:00 PM', '07:00 PM', '08:00 PM', '09:00 PM', '10:00 PM', '11:00 PM'
            ];
            
            const displayTime = times[timeValue] || '12:00 PM';
            $('#time-display').text(displayTime);
            
            // Update the narrative panel timestamp
            $('#narrative-timestamp').text(`Simulation Time: ${displayTime}`);
            
            // Update WildfireApp current time
            if (typeof WildfireApp !== 'undefined') {
                WildfireApp.currentTime = timeValue + 6; // Convert to 24-hour format starting at 6 AM
            }
        }
        
        function updateSimulationTime(timeValue) {
            const currentHour = timeValue + 6; // Convert slider value to 24-hour format
            
            // Update fire conditions based on time
            if (typeof FireManager !== 'undefined' && FireManager.createFirePerimeters) {
                FireManager.createFirePerimeters(currentHour);
            }
        }
        
        function playAnimation() {
            isPlaying = true;
            $('#play-toggle').html('‚è∏Ô∏è Pause Animation').removeClass('btn-primary').addClass('btn-warning');
            
            animationInterval = setInterval(() => {
                let currentValue = parseInt($('#time-slider').val());
                const maxValue = parseInt($('#time-slider').attr('max'));
                
                if (currentValue >= maxValue) {
                    currentValue = parseInt($('#time-slider').attr('min')); // Reset to beginning
                } else {
                    currentValue++;
                }
                
                // Update slider position
                $('#time-slider').val(currentValue);
                
                // Update time display and simulation
                updateTimeDisplay(currentValue);
                updateSimulationTime(currentValue);
                
            }, animationSpeed);
            
            console.log('Animation started with speed:', animationSpeed + 'ms');
        }
        
        function pauseAnimation() {
            isPlaying = false;
            $('#play-toggle').html('‚ñ∂Ô∏è Play Animation').removeClass('btn-warning').addClass('btn-primary');
            
            if (animationInterval) {
                clearInterval(animationInterval);
                animationInterval = null;
            }
            
            console.log('Animation paused');
        }
        
        function setAnimationSpeed(speed) {
            animationSpeed = speed;
            
            // If currently playing, restart with new speed
            if (isPlaying) {
                pauseAnimation();
                playAnimation();
            }
            
            console.log('Animation speed changed to:', speed + 'ms');
        }
        
        // Time slider change handler
        $('#time-slider').off('input change').on('input change', function() {
            const timeValue = parseInt($(this).val());
            updateTimeDisplay(timeValue);
            updateSimulationTime(timeValue);
        });
        
        // Play/Pause button
        $('#play-toggle').off('click').on('click', function() {
            if (isPlaying) {
                pauseAnimation();
            } else {
                playAnimation();
            }
        });
        
        // Speed control buttons
        $('#speed-fast').off('click').on('click', function() {
            setAnimationSpeed(500); // 0.5 seconds
            $('.speed-controls button').removeClass('btn-warning').addClass('btn-primary');
            $(this).removeClass('btn-primary').addClass('btn-warning');
            $('#speed-display').text('Fast (0.5s)');
        });
        
        $('#speed-normal').off('click').on('click', function() {
            setAnimationSpeed(1000); // 1 second
            $('.speed-controls button').removeClass('btn-warning').addClass('btn-primary');
            $(this).removeClass('btn-primary').addClass('btn-warning');
            $('#speed-display').text('Normal (1s)');
        });
        
        $('#speed-slow').off('click').on('click', function() {
            setAnimationSpeed(2000); // 2 seconds
            $('.speed-controls button').removeClass('btn-warning').addClass('btn-primary');
            $(this).removeClass('btn-primary').addClass('btn-warning');
            $('#speed-display').text('Slow (2s)');
        });
        
        // Initialize with current slider value
        const initialTime = parseInt($('#time-slider').val()) || 0;
        updateTimeDisplay(initialTime);
        updateSimulationTime(initialTime);
        
        // ADD THIS: Initialize the narrative timestamp
        const times = [
            '06:00 AM', '07:00 AM', '08:00 AM', '09:00 AM', '10:00 AM', '11:00 AM',
            '12:00 PM', '01:00 PM', '02:00 PM', '03:00 PM', '04:00 PM', '05:00 PM',
            '06:00 PM', '07:00 PM', '08:00 PM', '09:00 PM', '10:00 PM', '11:00 PM'
        ];
        const initialDisplayTime = times[initialTime] || '06:00 AM';
        $('#narrative-timestamp').text(`Simulation Time: ${initialDisplayTime}`);

        console.log('‚úÖ Time controls and animation set up successfully');
        
    }, 4000); // Wait longer for all components to be ready
}); // ADD this missing closing bracket for the time controls $(document).ready

<!-- CONSOLIDATED Analysis Tools functionality - REPLACE ALL ANALYSIS TOOL SCRIPTS WITH THIS ONE -->
$(document).ready(function() {
    setTimeout(function() {
        console.log('Setting up Analysis Tools functionality...');
        
        // Analysis Tools functionality
        let comparisonMode = false;
        
        // Historical Comparison Toggle
        $('#comparison-toggle').off('click').on('click', function() {
            comparisonMode = !comparisonMode;
            
            if (comparisonMode) {
                $(this).text('Exit Comparison').removeClass('btn-primary').addClass('btn-warning');
                startHistoricalComparison();
            } else {
                $(this).text('Historical Comparison').removeClass('btn-warning').addClass('btn-primary');
                exitHistoricalComparison();
            }
        });
        
        function startHistoricalComparison() {
            console.log('Starting historical comparison mode');
            
            // Show historical fires if not already visible
            if (!$('#historical-fires').is(':checked')) {
                $('#historical-fires').prop('checked', true).trigger('change');
            }
            
            // Add comparison overlay
            if (WildfireApp && WildfireApp.map) {
                const comparisonInfo = L.popup()
                    .setLatLng([33.7500, -116.5000])
                    .setContent(`
                        <div style="min-width: 250px;">
                            <h4 style="color: #2196F3;">üìä Historical Comparison Mode</h4>
                            <div style="font-size: 12px; line-height: 1.4;">
                                <strong>Now showing:</strong><br>
                                ‚Ä¢ Current active fires (red)<br>
                                ‚Ä¢ Historical fire locations (brown)<br>
                                ‚Ä¢ Fire risk patterns over time<br><br>
                                <strong>Analysis:</strong> Compare current fire behavior with historical patterns to predict spread and risk.
                            </div>
                        </div>
                    `)
                    .openOn(WildfireApp.map);
            }
            
            // Update narrative
            if (typeof WildfireApp !== 'undefined' && WildfireApp.updateNarrative) {
                const currentTime = $('#time-display').text() || '12:00 PM';
                WildfireApp.updateNarrative('üìä Historical comparison mode activated. Comparing current conditions with past fire events.');
                $('#narrative-timestamp').text(`Simulation Time: ${currentTime}`);
            }
        }
        
        function exitHistoricalComparison() {
            console.log('Exiting historical comparison mode');
            
            // Close any open popups
            if (WildfireApp && WildfireApp.map) {
                WildfireApp.map.closePopup();
            }
            
            // Update narrative
            if (typeof WildfireApp !== 'undefined' && WildfireApp.updateNarrative) {
                const currentTime = $('#time-display').text() || '12:00 PM';
                WildfireApp.updateNarrative('üìä Exited historical comparison mode. Returning to current fire monitoring.');
                $('#narrative-timestamp').text(`Simulation Time: ${currentTime}`);
            }
        }
        
        // Clear Routes functionality
        $('#clear-routes').off('click').on('click', function() {
            console.log('Clear routes button clicked');
            
            try {
                if (typeof RouteManager !== 'undefined' && RouteManager.clearRoutes) {
                    RouteManager.clearRoutes();
                    console.log('Routes cleared via RouteManager');
                } else if (typeof WildfireApp !== 'undefined' && WildfireApp.layers && WildfireApp.layers.routePlanning) {
                    WildfireApp.layers.routePlanning.clearLayers();
                    console.log('Routes cleared via WildfireApp');
                } else {
                    console.warn('No route clearing method available');
                    alert('‚ö†Ô∏è No routes to clear or route manager not available.');
                    return;
                }
                
                // Update narrative
                if (WildfireApp && WildfireApp.updateNarrative) {
                    const currentTime = $('#time-display').text() || '12:00 PM';
                    WildfireApp.updateNarrative('üóëÔ∏è All evacuation routes cleared.');
                    $('#narrative-timestamp').text(`Simulation Time: ${currentTime}`);
                }
                
                alert('‚úÖ All evacuation routes have been cleared from the map.');
                
            } catch (error) {
                console.error('Error clearing routes:', error);
                alert('‚ùå Error clearing routes. Check console for details.');
            }
        });
        
        // Export Report functionality
        $('#export-report').off('click').on('click', function() {
            console.log('Export report button clicked');
            
            try {
                const currentTime = $('#time-display').text() || '12:00 PM';
                const activeLayer = [];
                
                // Check which layers are active
                if ($('#fire-risk').is(':checked')) activeLayer.push('Fire Risk Surface');
                if ($('#fire-perimeters').is(':checked')) activeLayer.push('Fire Perimeters');
                if ($('#evacuation-buffers').is(':checked')) activeLayer.push('Evacuation Buffers');
                if ($('#population-centers').is(':checked')) activeLayer.push('Population Centers');
                if ($('#evacuation-centers').is(':checked')) activeLayer.push('Evacuation Centers');
                if ($('#evacuation-zones').is(':checked')) activeLayer.push('Evacuation Zones');
                if ($('#weather-stations').is(':checked')) activeLayer.push('Weather Stations');
                if ($('#historical-fires').is(':checked')) activeLayer.push('Historical Fires');
                if ($('#buffer-intersections').is(':checked')) activeLayer.push('Buffer Intersections');
                
                const reportData = {
                    timestamp: new Date().toISOString(),
                    simulationTime: currentTime,
                    activeLayers: activeLayer,
                    mapCenter: WildfireApp && WildfireApp.map ? WildfireApp.map.getCenter() : null,
                    zoomLevel: WildfireApp && WildfireApp.map ? WildfireApp.map.getZoom() : null,
                    comparisonMode: comparisonMode,
                    totalCommunities: 10 // Updated to reflect removal of Indian Wells and Bermuda Dunes
                };
                
                // Create comprehensive report content
                const reportContent = `
WILDFIRE RISK & EVACUATION REPORT
Generated: ${new Date().toLocaleString()}
Simulation Time: ${currentTime}
Report ID: WF_${new Date().getTime()}

===========================================

ACTIVE LAYERS (${activeLayer.length} total):
${activeLayer.length > 0 ? activeLayer.map(layer => '‚Ä¢ ' + layer).join('\n') : '‚Ä¢ No layers currently active'}

MAP SETTINGS:
‚Ä¢ Zoom Level: ${reportData.zoomLevel || 'Unknown'}
‚Ä¢ Map Center: ${reportData.mapCenter ? `${reportData.mapCenter.lat.toFixed(4)}, ${reportData.mapCenter.lng.toFixed(4)}` : 'Unknown'}
‚Ä¢ Comparison Mode: ${comparisonMode ? 'Active (Historical data visible)' : 'Inactive'}

COMMUNITY STATUS:
‚Ä¢ Total Communities Monitored: ${reportData.totalCommunities}
‚Ä¢ High-Risk Communities: San Jacinto, Hemet, Desert Hot Springs
‚Ä¢ Moderate-Risk Communities: Palm Desert, Rancho Mirage, La Quinta
‚Ä¢ Note: Indian Wells and Bermuda Dunes excluded from monitoring

SYSTEM STATUS:
‚Ä¢ Fire Risk Monitoring: Active
‚Ä¢ Evacuation Planning: Available
‚Ä¢ Route Generation: Functional
‚Ä¢ Community Alerts: Operational

ANALYSIS SUMMARY:
This report provides a snapshot of current wildfire conditions and evacuation 
planning status for the Coachella Valley region. The system monitors ${reportData.totalCommunities} 
population centers and provides real-time risk assessment and evacuation routing.

For emergency response coordination, refer to the active layers and ensure 
all high-risk communities have current evacuation plans.

Generated by Wildfire Risk & Evacuation Planner System
===========================================
                `;
                
                // Create and download the report
                const blob = new Blob([reportContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `wildfire_report_${new Date().getTime()}.txt`;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                console.log('Report exported successfully');
                
                // Update narrative
                if (typeof WildfireApp !== 'undefined' && WildfireApp.updateNarrative) {
                    WildfireApp.updateNarrative(`üìÑ Comprehensive wildfire report exported for ${currentTime}. ${activeLayer.length} layers included.`);
                    $('#narrative-timestamp').text(`Simulation Time: ${currentTime}`);
                }
                
                alert(`‚úÖ Report exported successfully!\n\n‚Ä¢ ${activeLayer.length} active layers included\n‚Ä¢ ${reportData.totalCommunities} communities monitored\n‚Ä¢ File saved as wildfire_report_${new Date().getTime()}.txt`);
                
            } catch (error) {
                console.error('Error exporting report:', error);
                alert('‚ùå Error exporting report. Check console for details.');
            }
        });
        
        console.log('‚úÖ Analysis Tools functionality set up successfully');
        
    }, 2000); // Wait for WildfireApp to be ready
});
</script>

<!-- Clear Routes functionality -->
<script>
$('#clear-routes').on('click', function() {
    console.log('Clear routes button clicked');
    
    if (typeof RouteManager !== 'undefined' && RouteManager.clearRoutes) {
        RouteManager.clearRoutes();
    } else if (typeof WildfireApp !== 'undefined' && WildfireApp.layers && WildfireApp.layers.routePlanning) {
        WildfireApp.layers.routePlanning.clearLayers();
        console.log('Routes cleared via WildfireApp');
        
        if (WildfireApp.updateNarrative) {
            WildfireApp.updateNarrative('üóëÔ∏è All evacuation routes cleared.');
        }
    } else {
        console.warn('No route clearing method available');
    }
});
</script>

<!-- Export Report functionality -->
<script>
$('#export-report').on('click', function() {
    console.log('Export report button clicked');
    
    const currentTime = $('#time-display').text() || '12:00 PM';
    const activeLayer = [];
    
    // Check which layers are active
    if ($('#fire-risk').is(':checked')) activeLayer.push('Fire Risk Surface');
    if ($('#fire-perimeters').is(':checked')) activeLayer.push('Fire Perimeters');
    if ($('#historical-fires').is(':checked')) activeLayer.push('Historical Fires');
    if ($('#weather-stations').is(':checked')) activeLayer.push('Weather Stations');
    if ($('#evacuation-centers').is(':checked')) activeLayer.push('Evacuation Centers');
    
    const reportData = {
        timestamp: new Date().toISOString(),
        simulationTime: currentTime,
        activeLayers: activeLayer,
        mapCenter: WildfireApp && WildfireApp.map ? WildfireApp.map.getCenter() : null,
        zoomLevel: WildfireApp && WildfireApp.map ? WildfireApp.map.getZoom() : null,
        comparisonMode: comparisonMode
    };
    
    // Create and download report
    const reportContent = `
WILDFIRE RISK & EVACUATION REPORT
Generated: ${new Date().toLocaleString()}
Simulation Time: ${currentTime}

ACTIVE LAYERS:
${activeLayer.map(layer => '‚Ä¢ ' + layer).join('\n')}

MAP SETTINGS:
‚Ä¢ Zoom Level: ${reportData.zoomLevel || 'Unknown'}
‚Ä¢ Center: ${reportData.mapCenter ? `${reportData.mapCenter.lat.toFixed(4)}, ${reportData.mapCenter.lng.toFixed(4)}` : 'Unknown'}
‚Ä¢ Comparison Mode: ${comparisonMode ? 'Active' : 'Inactive'}

ANALYSIS:
This report provides a snapshot of current wildfire conditions and evacuation planning status.
Use this data for emergency response coordination and risk assessment.
    `;
    
    const blob = new Blob([reportContent], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `wildfire_report_${new Date().getTime()}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    console.log('Report exported successfully');
    
    if (typeof WildfireApp !== 'undefined' && WildfireApp.updateNarrative) {
        WildfireApp.updateNarrative(`üìÑ Wildfire report exported for ${currentTime}.`);
    }
});
</script>

<!-- Evacuation Route Planning functionality -->
<script>
$('#plan-routes').off('click').on('click', function() {
    console.log('Plan evacuation routes button clicked');
    
    if (!WildfireApp || !WildfireApp.map || !WildfireApp.layers) {
        console.error('WildfireApp not properly initialized');
        alert('‚ùå Application not ready. Please wait for the map to fully load.');
        return;
    }
    
    if (!WildfireApp.layers.routePlanning) {
        console.error('Route planning layer not available');
        alert('‚ùå Route planning layer not available.');
        return;
    }
    
    // Clear existing routes first
    try {
        WildfireApp.layers.routePlanning.clearLayers();
        console.log('Cleared existing routes');
    } catch (error) {
        console.warn('Could not clear existing routes:', error);
    }
    
    try {
        // Population centers (communities) - Updated to exclude Indian Wells and Bermuda Dunes
        const populationCenters = [
            { name: 'Palm Springs', coords: [33.8303, -116.5453] },
            { name: 'Desert Hot Springs', coords: [33.9614, -116.5019] },
            { name: 'Palm Desert', coords: [33.7222, -116.3747] },
            { name: 'Cathedral City', coords: [33.7797, -116.4653] },
            { name: 'Rancho Mirage', coords: [33.7397, -116.4128] },
            { name: 'La Quinta', coords: [33.6603, -116.3100] },
            { name: 'Coachella', coords: [33.6803, -116.1739] },
            { name: 'Indio', coords: [33.7206, -116.2156] },
            { name: 'San Jacinto', coords: [33.7839, -116.9586] },
            { name: 'Hemet', coords: [33.7475, -116.9719] }
        ];
        
        // Evacuation centers (safe zones)
        const evacuationCenters = [
            { name: 'Palm Springs Convention Center', coords: [33.8175, -116.5450], capacity: 2500 },
            { name: 'Coachella Valley Arena', coords: [33.6803, -116.2156], capacity: 1800 },
            { name: 'Hemet Community Center', coords: [33.7428, -116.9753], capacity: 1200 },
            { name: 'Desert Recreation District', coords: [33.7269, -116.2725], capacity: 2000 },
            { name: 'College of the Desert', coords: [33.7200, -116.3600], capacity: 3000 }
        ];
        
        let routeCount = 0;
        const colors = ['#FF5722', '#E91E63', '#9C27B0', '#673AB7', '#3F51B5', '#2196F3', '#4CAF50', '#FF9800', '#795548', '#607D8B'];
        
        console.log(`Creating routes from ${populationCenters.length} communities to ${evacuationCenters.length} evacuation centers`);
        
        // Create routes for each population center
        populationCenters.forEach((center, index) => {
            try {
                // Find nearest evacuation center
                let nearestCenter = evacuationCenters[0];
                let minDistance = Infinity;
                
                evacuationCenters.forEach(evac => {
                    const lat1 = center.coords[0];
                    const lon1 = center.coords[1];
                    const lat2 = evac.coords[0];
                    const lon2 = evac.coords[1];
                    
                    const dLat = (lat2 - lat1) * Math.PI / 180;
                    const dLon = (lon2 - lon1) * Math.PI / 180;
                    const distance = Math.sqrt(dLat * dLat + dLon * dLon);
                    
                    if (distance < minDistance) {
                        minDistance = distance;
                        nearestCenter = evac;
                    }
                });
                
                const distanceMiles = (minDistance * 69).toFixed(1);
                const estimatedTime = Math.ceil(distanceMiles / 25);
                
                console.log(`Routing ${center.name} to ${nearestCenter.name} (distance: ${distanceMiles} miles)`);
                
                // Create route line
                const routeColor = colors[index % colors.length];
                const routeLine = L.polyline([center.coords, nearestCenter.coords], {
                    color: routeColor,
                    weight: 4,
                    opacity: 0.8,
                    dashArray: '10,5',
                    className: 'evacuation-route'
                });
                
                routeLine.addTo(WildfireApp.layers.routePlanning);
                
                routeLine.bindPopup(`
                    <div style="min-width: 220px;">
                        <h4 style="color: ${routeColor}; margin-bottom: 8px;">üöó Evacuation Route #${index + 1}</h4>
                        <div style="font-size: 13px; line-height: 1.4;">
                            <strong>From:</strong> ${center.name}<br>
                            <strong>To:</strong> ${nearestCenter.name}<br>
                            <strong>Distance:</strong> ${distanceMiles} miles<br>
                            <strong>Est. Time:</strong> ${estimatedTime} minutes<br>
                            <strong>Capacity:</strong> ${nearestCenter.capacity} people<br>
                            <strong>Status:</strong> <span style="color: #28a745;">Route Clear</span>
                        </div>
                    </div>
                `);
                
                // Add start marker
                const startMarker = L.marker(center.coords, {
                    icon: L.divIcon({
                        className: 'route-start-marker',
                        html: `<div style="background: ${routeColor}; color: white; padding: 3px 6px; border-radius: 10px; font-size: 10px; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.4); white-space: nowrap;">üìç START</div>`,
                        iconSize: [60, 20],
                        iconAnchor: [30, 10]
                    })
                });
                
                startMarker.addTo(WildfireApp.layers.routePlanning);
                
                // Add end marker
                const endMarker = L.marker(nearestCenter.coords, {
                    icon: L.divIcon({
                        className: 'route-end-marker',
                        html: `<div style="background: #28a745; color: white; padding: 3px 6px; border-radius: 10px; font-size: 10px; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.4); white-space: nowrap;">üè• SAFE</div>`,
                        iconSize: [50, 20],
                        iconAnchor: [25, 10]
                    })
                });
                
                endMarker.addTo(WildfireApp.layers.routePlanning);
                
                routeCount++;
                
            } catch (error) {
                console.error(`Error creating route for ${center.name}:`, error);
            }
        });
        
        // Add route planning layer to map
        if (!WildfireApp.map.hasLayer(WildfireApp.layers.routePlanning)) {
            WildfireApp.layers.routePlanning.addTo(WildfireApp.map);
            console.log('Added route planning layer to map');
        }
        
        console.log(`‚úÖ Successfully created ${routeCount} evacuation routes`);
        
        // Update narrative
        if (WildfireApp.updateNarrative) {
            const currentTime = $('#time-display').text() || '12:00 PM';
            WildfireApp.updateNarrative(`üó∫Ô∏è ${routeCount} evacuation routes planned connecting communities to nearest safe zones.`);
            $('#narrative-timestamp').text(`Simulation Time: ${currentTime}`);
        }
        
        alert(`‚úÖ Successfully planned ${routeCount} evacuation routes!\n\nClick on route lines and markers for details.`);
        
    } catch (error) {
        console.error('Error planning evacuation routes:', error);
        alert('‚ùå Error planning evacuation routes. Check console for details.');
    }
});
</script>

<!-- Fix the debug functions script: -->
<script>
function debugManagers() {
    console.log('=== MANAGER DEBUG ===');
    console.log('WeatherManager exists:', typeof WeatherManager !== 'undefined');
    console.log('BufferSystem exists:', typeof BufferSystem !== 'undefined');
    
    if (WeatherManager) {
        console.log('WeatherManager.createWeatherStations exists:', typeof WeatherManager.createWeatherStations === 'function');
        console.log('WeatherManager object:', WeatherManager);
    }
    
    if (BufferSystem) {
        console.log('BufferSystem.createBufferIntersections exists:', typeof BufferSystem.createBufferIntersections === 'function');
        console.log('BufferSystem object:', BufferSystem);
    }
    
    if (WildfireApp && WildfireApp.layers) {
        console.log('WildfireApp.layers exists:', !!WildfireApp.layers);
        console.log('weatherStations layer exists:', !!WildfireApp.layers.weatherStations);
        
        if (WildfireApp.layers.weatherStations) {
            console.log('weatherStations layer count:', WildfireApp.layers.weatherStations.getLayers().length);
        }
        if (WildfireApp.layers.bufferIntersections) {
            console.log('bufferIntersections layer count:', WildfireApp.layers.bufferIntersections.getLayers().length);
        }
    }
    console.log('==================');
}

function testWeatherStations() {
    console.log('=== TESTING WEATHER STATIONS ===');
    
    // First check if managers exist
    if (!WeatherManager) {
        console.error('WeatherManager does not exist!');
        return;
    }
    
    if (!WeatherManager.createWeatherStations) {
        console.error('WeatherManager.createWeatherStations method does not exist!');
        return;
    }
    
    // Check if layer exists
    if (!WildfireApp.layers || !WildfireApp.layers.weatherStations) {
        console.error('weatherStations layer does not exist!');
        return;
    }
    
    console.log('Manually creating weather stations...');
    try {
        WeatherManager.createWeatherStations();
        console.log('Weather stations created successfully!');
        console.log('Layer count:', WildfireApp.layers.weatherStations.getLayers().length);
        
        // Try to add to map
        if (WildfireApp.map) {
            WildfireApp.layers.weatherStations.addTo(WildfireApp.map);
            console.log('Weather stations added to map!');
        }
    } catch (error) {
        console.error('Error creating weather stations:', error);
    }
    console.log('================================');
}

// Make functions globally available
window.debugManagers = debugManagers;
window.testWeatherStations = testWeatherStations;

console.log('‚úÖ Debug functions loaded. Try: debugManagers() or testWeatherStations()');

// Population centers check (only run if WildfireApp is ready)
setTimeout(function() {
    if (WildfireApp && WildfireApp.populationCenters) {
        const communityNames = WildfireApp.populationCenters.map(center => center.name);
        console.log('Current communities:', communityNames);
        console.log('Total communities:', communityNames.length); // Should show 10
        console.log('Indian Wells removed:', !communityNames.includes('Indian Wells'));
        console.log('Bermuda Dunes removed:', !communityNames.includes('Bermuda Dunes'));
        console.log('‚úÖ Bermuda Dunes and Indian Wells successfully removed from all arrays');
    }
}, 5000);
</script>

<!-- Alert Communities functionality -->
<script>
$(document).ready(function() {
    setTimeout(function() {
        $('#alert-communities').off('click').on('click', function() {
            console.log('Alert communities button clicked');
            
            if (!WildfireApp || !WildfireApp.map || !WildfireApp.layers) {
                console.error('WildfireApp not properly initialized');
                alert('‚ùå Application not ready. Please wait for the map to fully load.');
                return;
            }
            
            try {
                // Get current time and fire risk level
                const currentTime = WildfireApp.currentTime || 12;
                const timeDisplay = $('#time-display').text() || '12:00 PM';
                
                // Determine risk level based on time
                let riskLevel = 'Moderate';
                let alertColor = '#FF9800';
                let alertMessage = 'Fire watch in effect';
                
                if (currentTime >= 14 && currentTime <= 17) { // 2-5 PM
                    riskLevel = 'Extreme';
                    alertColor = '#D32F2F';
                    alertMessage = 'IMMEDIATE EVACUATION RECOMMENDED';
                } else if (currentTime >= 12 && currentTime < 18) { // Noon-6 PM
                    riskLevel = 'High';
                    alertColor = '#FF5722';
                    alertMessage = 'EVACUATION WARNING - Prepare to leave';
                } else if (currentTime >= 10 && currentTime < 12) { // 10 AM-Noon
                    riskLevel = 'Elevated';
                    alertColor = '#FF7043';
                    alertMessage = 'Fire watch - Stay alert';
                }
                
                // Communities with their risk levels (10 communities - no Indian Wells or Bermuda Dunes)
                const communities = [
                    { name: 'Palm Springs', coords: [33.8303, -116.5453], risk: 'High' },
                    { name: 'Desert Hot Springs', coords: [33.9614, -116.5019], risk: 'Very High' },
                    { name: 'Palm Desert', coords: [33.7222, -116.3747], risk: 'Moderate' },
                    { name: 'Cathedral City', coords: [33.7797, -116.4653], risk: 'High' },
                    { name: 'Rancho Mirage', coords: [33.7397, -116.4128], risk: 'Moderate' },
                    { name: 'La Quinta', coords: [33.6603, -116.3100], risk: 'Moderate' },
                    { name: 'Coachella', coords: [33.6803, -116.1739], risk: 'High' },
                    { name: 'Indio', coords: [33.7206, -116.2156], risk: 'High' },
                    { name: 'San Jacinto', coords: [33.7839, -116.9586], risk: 'Very High' },
                    { name: 'Hemet', coords: [33.7475, -116.9719], risk: 'High' }
                ];
                
                let alertCount = 0;
                
                // Ensure evacuation zones layer exists
                if (!WildfireApp.layers.evacuationZones) {
                    WildfireApp.layers.evacuationZones = L.layerGroup();
                }
                
                // Clear existing alerts
                WildfireApp.layers.evacuationZones.clearLayers();
                
                communities.forEach(community => {
                    // Create alert zone around each community
                    const alertRadius = community.risk === 'Very High' ? 3000 : 
                                       community.risk === 'High' ? 2000 : 1500;
                    
                    const alertZone = L.circle(community.coords, {
                        color: alertColor,
                        fillColor: alertColor,
                        fillOpacity: 0.2,
                        weight: 3,
                        radius: alertRadius,
                        dashArray: '5,10'
                    }).addTo(WildfireApp.layers.evacuationZones);
                    
                    alertZone.bindPopup(`

                        <div style="min-width: 250px;">
                            <h4 style="color: ${alertColor};">üö® FIRE ALERT - ${community.name}</h4>
                            <div style="font-size: 12px;">
                                <strong>Alert Level:</strong> <span style="color: ${alertColor};">${riskLevel}</span><br>
                                <strong>Time:</strong> ${timeDisplay}<br>
                                <strong>Action:</strong> ${alertMessage}<br>
                                <strong>Community Risk:</strong> ${community.risk}<br>
                                <strong>Alert Radius:</strong> ${(alertRadius/1000).toFixed(1)} km
                            </div>
                        </div>
                    `);
                    
                    // Add alert marker at community center
                    const alertMarker = L.marker(community.coords, {
                        icon: L.divIcon({
                            className: 'alert-marker',
                            html: `<div style="background: ${alertColor}; color: white; padding: 6px; border-radius: 50%; font-size: 16px; border: 3px solid white; box-shadow: 0 3px 6px rgba(0,0,0,0.4); animation: pulse 1.5s infinite;">üö®</div>`,
                            iconSize: [32, 32],
                            iconAnchor: [16, 16]
                        })
                    }).addTo(WildfireApp.layers.evacuationZones);
                    
                    alertMarker.bindPopup(`
                        <div style="min-width: 200px;">
                            <h4 style="color: ${alertColor};">üö® ${community.name} ALERT</h4>
                            <div style="font-size: 12px;">
                                <strong>${alertMessage}</strong><br>
                                Risk Level: ${community.risk}<br>
                                Time: ${timeDisplay}
                            </div>
                        </div>
                    `);
                    
                    alertCount++;
                });
                
                // Add evacuation zones layer to map if not already added
                if (!WildfireApp.map.hasLayer(WildfireApp.layers.evacuationZones)) {
                    WildfireApp.layers.evacuationZones.addTo(WildfireApp.map);
                }
                
                console.log(`‚úÖ Alerted ${alertCount} communities with ${riskLevel} risk level`);
                
                // Update narrative
                if (WildfireApp.updateNarrative) {
                    WildfireApp.updateNarrative(`üö® ALERT: ${alertCount} communities notified. Risk Level: ${riskLevel}. ${alertMessage}`);
                    $('#narrative-timestamp').text(`Simulation Time: ${timeDisplay}`);
                }
                
                // Auto-check the evacuation zones checkbox
                $('#evacuation-zones').prop('checked', true);
                
                alert(`üö® Successfully alerted ${alertCount} communities!\n\nRisk Level: ${riskLevel}\nAction Required: ${alertMessage}\n\nClick on alert zones and markers for details.`);
                
            } catch (error) {
                console.error('Error alerting communities:', error);
                alert('‚ùå Error alerting communities. Check console for details.');
            }
        });
    }, 3000); // Wait for WildfireApp to be ready
});
</script>
</body>
</html>